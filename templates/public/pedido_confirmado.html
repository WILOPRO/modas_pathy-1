{% extends 'public/base.html' %}

{% block title %}Pedido Confirmado — Modas Pathy{% endblock %}

{% block styles %}
<style>
    .hero-confirm {
        background: linear-gradient(135deg, rgba(143,45,86,0.08), rgba(37,211,102,0.08));
        border-radius: var(--radius-2xl);
        padding: 2.5rem;
        box-shadow: var(--shadow-lg);
    }
</style>
{% endblock %}

{% block content %}
<section class="container py-4 py-md-5">
    <div class="hero-confirm text-center mb-4" data-aos="fade-up">
        <div class="d-inline-flex align-items-center justify-content-center rounded-circle bg-success text-white mb-3" style="width: 64px; height: 64px;">
            <i class="bi bi-check-lg fs-3"></i>
        </div>
        <h1 class="mb-2">¡Pedido generado con éxito!</h1>
        <p class="text-muted mb-3">Guarde este número para rastrear su pedido</p>
        <h2 class="text-gradient mb-0">{{ pedido.order_code }}</h2>
    </div>

    <div class="row g-4">
        <div class="col-md-6" data-aos="fade-right">
            <div class="card border-0 shadow-sm">
                <div class="card-body">
                    <div class="d-flex align-items-center gap-3 mb-3">
                        <div class="badge bg-primary-subtle text-primary px-3 py-2 rounded-pill">
                            Detalles del producto
                        </div>
                    </div>
                    <div class="d-flex gap-3">
                        <div class="ratio ratio-1x1 rounded-4 overflow-hidden bg-light" style="width: 120px;">
                            {% if pedido.image_url %}
                            <img src="{{ pedido.image_url }}" alt="Producto" style="width: 100%; height: 100%; object-fit: cover;">
                            {% elif pedido.product and pedido.product.main_image %}
                            <img src="{{ url_for('static', filename='uploads/' ~ pedido.product.main_image.filename) }}" alt="Producto" style="width: 100%; height: 100%; object-fit: cover;">
                            {% else %}
                            <div class="d-flex align-items-center justify-content-center h-100 text-muted">
                                <i class="bi bi-image"></i>
                            </div>
                            {% endif %}
                        </div>
                        <div>
                            <h5 class="mb-1">{{ pedido.product.name if pedido.product else 'Producto' }}</h5>
                            <p class="text-muted mb-2">Método de pago: <strong>{{ pedido.payment_method|capitalize }}</strong></p>
                            <p class="mb-0 fw-semibold">Bs {{ '%.2f'|format(pedido.total) }}</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-6" data-aos="fade-left">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-body d-flex flex-column gap-3">
                    <div class="d-flex flex-column gap-2">
                        <a class="btn btn-success btn-lg w-100" id="btn-confirm-wa">
                            <i class="bi bi-whatsapp me-2"></i>Enviar a WhatsApp
                        </a>
                        <button class="btn btn-outline btn-lg w-100" id="btn-capture">
                            <i class="bi bi-camera me-2"></i>Capturar pantalla
                        </button>
                    </div>
                    <div class="d-flex flex-column gap-2">
                        <a href="{{ url_for('rastrear_pedido', code=pedido.order_code) }}" class="btn btn-primary btn-lg w-100">
                            <i class="bi bi-compass me-2"></i>Rastrear pedido
                        </a>
                        <a href="{{ url_for('catalogo') }}" class="btn btn-light btn-lg w-100">Seguir comprando</a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', () => {
    const waBtn = document.getElementById('btn-confirm-wa');
    const captureBtn = document.getElementById('btn-capture');
    const code = "{{ pedido.order_code }}";
    const productName = "{{ pedido.product.name if pedido.product else 'Producto' }}";
    const total = "{{ '%.2f'|format(pedido.total) }}";
    const image = "{{ pedido.image_url or (pedido.product.main_image and url_for('static', filename='uploads/' ~ pedido.product.main_image.filename)) or '' }}";
    const number = "{{ contact_info.whatsapp|replace('+','')|replace(' ','') if contact_info and contact_info.whatsapp else '' }}";

    if (waBtn && number) {
        waBtn.addEventListener('click', () => {
            const text = [
                'Vengo desde la página Modas Pathy',
                `Pedido: ${code}`,
                `Producto: ${productName}`,
                `Total: Bs ${total}`,
                image ? `Imagen: ${image}` : ''
            ].filter(Boolean).join('\n');
            const url = `https://wa.me/${number}?text=${encodeURIComponent(text)}`;
            window.open(url, '_blank');
        });
    } else if (waBtn) {
        waBtn.disabled = true;
    }

    if (captureBtn) {
        captureBtn.addEventListener('click', async () => {
            try {
                const { default: html2canvas } = await import('https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/+esm');
                const section = document.querySelector('section');
                const canvas = await html2canvas(section);
                const link = document.createElement('a');
                link.download = `${code}.png`;
                link.href = canvas.toDataURL('image/png');
                link.click();
            } catch (e) {
                window.print();
            }
        });
    }
});
</script>
{% endblock %}
