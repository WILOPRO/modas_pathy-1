{% extends 'admin/base_admin.html' %}

{% block title %}{{ 'Nuevo Pedido Personalizado' if nuevo else 'Pedido Personalizado' }} - Modas Pathy{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="d-flex align-items-center justify-content-between mb-4 compact-header">
        <div>
            <p class="text-muted small mb-1">Gestión de pedidos personalizados</p>
            <h2 class="mb-0">{{ 'Nuevo Pedido Personalizado' if nuevo else 'Editar Pedido' }}</h2>
        </div>
        <a href="{{ url_for('admin_custom_orders') }}" class="btn btn-outline-secondary">
            <i class="bi bi-arrow-left"></i> Volver
        </a>
    </div>

    <div class="card shadow-sm border-0">
        <div class="card-body compact-order-body">
            <form method="post" enctype="multipart/form-data">
                {{ form.hidden_tag() }}
                {% if form.errors %}
                <div class="alert alert-danger">
                    <strong>Hay errores en el formulario:</strong>
                    <ul class="mb-0">
                        {% for field_name, field_errors in form.errors.items() %}
                            {% for error in field_errors %}
                                <li>{{ getattr(form, field_name).label.text }}: {{ error }}</li>
                            {% endfor %}
                        {% endfor %}
                    </ul>
                </div>
                {% endif %}
                <div class="row g-4 compact-order-layout">
                    <div class="col-lg-8">
                        <div id="stepCliente" class="mb-4">
                            <div class="d-flex align-items-center gap-2 mb-3">
                                <span class="badge text-bg-light border step-chip" data-step="1">Paso 1</span>
                                <h5 class="fw-bold mb-0">Cliente</h5>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Buscar por telefono o nombre</label>
                                <div class="input-group">
                                    <input type="text" class="form-control" id="clientSearch" placeholder="Ej: 70000000 o Maria">
                                    <button class="btn btn-primary" type="button" id="btnSearchClient">
                                        <i class="bi bi-search"></i> Buscar
                                    </button>
                                </div>
                                <small class="text-muted">Valida si el cliente existe antes de crear uno nuevo.</small>
                                <div class="small mt-2 text-primary" id="clientSearchStatus">Busca un cliente para comenzar.</div>
                            </div>
                            <div class="mb-3">
                                <div class="d-flex align-items-center justify-content-between">
                                    <label class="form-label mb-1">Resultados</label>
                                    <div class="d-flex gap-2">
                                        <button class="btn btn-sm btn-outline-primary" type="button" id="openNewClient">
                                            <i class="bi bi-person-plus"></i> Nuevo cliente
                                        </button>
                                        <button class="btn btn-sm btn-outline-secondary" type="button" id="resetClientSearch">
                                            <i class="bi bi-arrow-repeat"></i> Limpiar
                                        </button>
                                    </div>
                                </div>
                                <div class="list-group" id="clientResults">
                                    <div class="list-group-item text-muted small">Sin resultados. Ingresa un nombre o telefono y presiona buscar.</div>
                                </div>
                            </div>
                            <div class="alert alert-light border d-flex align-items-center justify-content-between" id="selectedClientBox">
                                <div>
                                    <div class="fw-semibold mb-0" id="selectedClientName">Sin cliente seleccionado</div>
                                    <div class="small text-muted" id="selectedClientMeta">Selecciona un cliente existente o registra uno nuevo.</div>
                                </div>
                                <div class="d-flex gap-2">
                                    <button class="btn btn-outline-secondary btn-sm" type="button" id="clearSelectedClient">
                                        Cambiar
                                    </button>
                                </div>
                            </div>
                            {{ form.client_id(class="form-select d-none", id="client_id") }}
                        </div>

                        <div id="stepGarment" class="mb-4 d-none">
                            <div class="d-flex align-items-center gap-2 mb-3">
                                <span class="badge text-bg-light border step-chip" data-step="2">Paso 2</span>
                                <h5 class="fw-bold mb-0">Tipo de prenda</h5>
                            </div>
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label class="form-label">Tipo de prenda</label>
                                    {{ form.garment_type(class="form-select", id="garment_type") }}
                                    <small class="text-muted">Las medidas se adaptaran a la prenda seleccionada.</small>
                                </div>
                            </div>
                        </div>

                        <div id="stepMeasures" class="mb-4 d-none">
                            <div class="d-flex justify-content-between align-items-center">
                                <div class="d-flex align-items-center gap-2">
                                    <span class="badge text-bg-light border step-chip" data-step="3">Paso 3</span>
                                    <h5 class="fw-bold mb-0">Prendas del pedido</h5>
                                </div>
                                <button class="btn btn-outline-primary btn-sm" type="button" id="btnSaveMeasures">
                                    <i class="bi bi-save me-1"></i>Guardar/actualizar medidas del cliente
                                </button>
                            </div>
                            <div class="row g-2 mt-2" id="measurements">
                                {% for field in ['largo_espalda','largo_delantero','cintura','busto','media_cintura','sisa','escote','largo_manga','puno','cuello','abertura','ancho_espalda','figura','alforza','panos','wato','corridas','cadera','talla','quebrado','numero_torsales','metros','color'] %}
                                {% set is_color = field == 'color' %}
                                <div class="col-lg-6 col-12 measure-field measure-row" data-field="{{ field }}">
                                    <label class="form-label text-capitalize mb-0 flex-grow-1">{{ field.replace('_',' ') }}</label>
                                    <div class="measure-input">
                                        {% if is_color %}
                                            {{ getattr(form, field)(class="form-control form-control-sm") }}
                                        {% else %}
                                            {{ getattr(form, field)(class="form-control form-control-sm text-end", inputmode="decimal", pattern="^[0-9]+([\\.,][0-9]+)?$") }}
                                        {% endif %}
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                            <small class="text-muted">Solo se mostraran las medidas que aplican para la prenda seleccionada.</small>
                            <div class="small text-danger mt-2 d-none" id="measureSaveWarning">Selecciona un cliente existente para guardar sus medidas.</div>
                            <div class="alert alert-light border mt-3">
                                <div class="form-check">
                                    {{ form.reference_from_garment(class="form-check-input", id="reference_from_garment") }}
                                    <label class="form-check-label fw-semibold" for="reference_from_garment">
                                        El cliente dejó una prenda de referencia
                                    </label>
                                </div>
                                <div class="mt-2 d-none" id="referenceNotesBox">
                                    <label class="form-label">Detalle de la prenda de referencia</label>
                                    {{ form.reference_notes(class="form-control", rows="2", placeholder="Ej: Traje azul talla 40, usar como guía de medidas") }}
                                </div>
                            </div>
                            <div class="mt-3">
                                <button type="button" class="btn btn-outline-success" id="btnAddItem">
                                    <i class="bi bi-plus-circle me-1"></i>Agregar prenda a la lista
                                </button>
                            </div>
                            <div class="mt-3">
                                <h6 class="fw-bold">Prendas agregadas</h6>
                                <div id="itemsList" class="small text-muted">Aun no hay prendas agregadas.</div>
                            </div>
                            {{ form.items_json(type="hidden", id="items_json") }}
                        </div>

                        <div id="stepFinal" class="mb-4 d-none">
                            <div class="d-flex align-items-center gap-2 mb-3">
                                <span class="badge text-bg-light border step-chip" data-step="4">Paso 4</span>
                                <h5 class="fw-bold mb-0">Fechas, montos y adjuntos</h5>
                            </div>
                            <div class="row g-3">
                                <div class="col-md-4">
                                    <label class="form-label">Fecha de entrega</label>
                                    {{ form.delivery_date(class="form-control", type="date", required=True) }}
                                </div>
                                <div class="col-md-4 d-flex align-items-center">
                                    <div class="form-check mt-3">
                                        {{ form.is_urgent(class="form-check-input", id="is_urgent") }}
                                        <label class="form-check-label" for="is_urgent">Urgente</label>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label">Estado</label>
                                    {{ form.status(class="form-select") }}
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label">Adelanto</label>
                                    {{ form.deposit(class="form-control", placeholder="0.00") }}
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label">Total *</label>
                                    {{ form.total(class="form-control", placeholder="0.00", required=True) }}
                                </div>
                            </div>

                            <div class="mt-4">
                                <h6 class="fw-bold mb-2">Observaciones</h6>
                                {{ form.observations(class="form-control", rows="3", placeholder="Notas adicionales...") }}
                            </div>

                            <div class="mt-4">
                                <h6 class="fw-bold mb-2">Imagenes</h6>
                                {{ form.images(class="form-control", multiple=true) }}
                                <small class="text-muted">Puedes subir varias imagenes de telas o referencias.</small>
                                <div class="mt-2" id="imagePreviewWrapper">
                                    <div class="text-muted small" id="imagePreviewEmpty">Aún no hay imágenes seleccionadas.</div>
                                    <div class="d-flex flex-wrap gap-2" id="imagePreviewList"></div>
                                </div>
                            </div>
                        </div>
<div class="col-lg-4">
                        <div class="card shadow-sm">
                            <div class="card-body">
                                <h5 class="fw-bold">Resumen</h5>
                                <p class="text-muted small mb-3">Completa la información requerida para registrar el pedido.</p>
                                <div class="d-grid gap-2 sticky-actions">
                                    <button type="submit" class="btn btn-primary">
                                        <i class="bi bi-check-circle me-1"></i>Guardar pedido
                                    </button>
                                    <a href="{{ url_for('admin_custom_orders') }}" class="btn btn-light">Cancelar</a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal para nuevo cliente -->
<div class="modal fade" id="newClientModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Nuevo cliente</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label">Nombre</label>
                    <input type="text" class="form-control" id="modalClientName" placeholder="Nombre completo">
                </div>
                <div class="mb-3">
                    <label class="form-label">Número de celular (opcional)</label>
                    <input type="text" class="form-control" id="modalClientPhone" placeholder="Ej: 70000000">
                </div>
                <div class="mb-3">
                    <label class="form-label">Número de carnet o NIT (opcional)</label>
                    <input type="text" class="form-control" id="modalClientIdNumber" placeholder="Ej: 1234567">
                </div>
                <div class="text-danger small d-none" id="newClientError"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-light" data-bs-dismiss="modal" id="btnCancelNewClient">Cancelar</button>
                <button type="button" class="btn btn-primary" id="btnSaveNewClient">Registrar cliente</button>
            </div>
        </div>
    </div>
</div>

<!-- Burbuja de resumen rápido -->
<button type="button" class="btn btn-primary quick-summary-btn shadow" id="quickSummaryToggle" aria-label="Mostrar resumen rápido">
    <i class="bi bi-card-checklist"></i>
</button>
<div class="quick-summary-card shadow d-none" id="quickSummaryPanel">
    <div class="d-flex justify-content-between align-items-center mb-2">
        <div class="fw-bold small mb-0">Resumen rápido</div>
        <button type="button" class="btn btn-outline-secondary btn-sm" id="quickSummaryClose" aria-label="Cerrar resumen">
            <i class="bi bi-x-lg"></i>
        </button>
    </div>
    <div class="small">
        <div class="mb-1"><strong>Cliente:</strong> <span id="quickResumenCliente">-</span></div>
        <div class="mb-1"><strong>Prendas:</strong> <span id="quickResumenPrendas">0</span></div>
        <div class="mb-1"><strong>Entrega:</strong> <span id="quickResumenEntrega">-</span></div>
        <div class="mb-1"><strong>Total:</strong> Bs <span id="quickResumenTotal">0.00</span></div>
        <div class="mb-1"><strong>Adelanto:</strong> Bs <span id="quickResumenAdelanto">0.00</span></div>
        <div class="mb-1"><strong>Prendas agregadas:</strong></div>
        <div class="text-muted" id="quickResumenItems">Aun no hay prendas agregadas.</div>
    </div>
</div>

<!-- Confirmacion de resumen antes de guardar -->
<div class="modal fade" id="confirmResumenModal" tabindex="-1" aria-labelledby="confirmResumenLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered modal-full-mobile">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="confirmResumenLabel">Confirma el pedido</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row g-3">
                    <div class="col-md-6"><strong>Cliente:</strong> <span id="confirmResumenCliente">-</span></div>
                    <div class="col-md-3"><strong>Prendas:</strong> <span id="confirmResumenPrendas">0</span></div>
                    <div class="col-md-3"><strong>Entrega:</strong> <span id="confirmResumenEntrega">-</span></div>
                    <div class="col-md-3"><strong>Total:</strong> Bs <span id="confirmResumenTotal">0.00</span></div>
                    <div class="col-md-3"><strong>Adelanto:</strong> Bs <span id="confirmResumenAdelanto">0.00</span></div>
                </div>
                <div class="mt-3">
                    <strong>Prendas agregadas</strong>
                    <div class="small text-muted" id="confirmResumenItems">Aun no hay prendas agregadas.</div>
                </div>
                <div class="mt-3">
                    <strong>Observaciones</strong>
                    <div class="small" id="confirmResumenObservaciones">-</div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-outline-secondary" id="confirmResumenPrint">Imprimir</button>
                <button type="button" class="btn btn-outline-primary" id="confirmResumenDownload">Descargar imagen</button>
                <button type="button" class="btn btn-primary" id="confirmResumenSubmit">Confirmar y guardar</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<style>
.measure-row { padding: 0.35rem 0.25rem; display: flex; align-items: center; gap: 0.5rem; }
.measure-row .form-label { font-size: 0.9rem; text-transform: uppercase; letter-spacing: 0.02em; font-weight: 600; }
.measure-input .form-control { max-width: 110px; padding: 0.35rem 0.5rem; }
.measure-input .form-control.measure-highlight {
    border-color: #ffe600 !important;
    box-shadow: 0 0 0 0.2rem rgba(255, 230, 0, 0.6);
}
.step-chip { transition: all 0.2s ease; }
.step-chip.active-step {
    background: linear-gradient(135deg, #48e49b, #2dd17a);
    color: #0b3a1d;
    border-color: #1f9f57;
    box-shadow: 0 0 0 0.2rem rgba(72, 228, 155, 0.35);
}
.step-chip.pending-step {
    background: #f3f4f6;
    color: #6c757d;
    border-color: #d8d8d8;
}
.quick-summary-btn {
    position: fixed;
    right: 16px;
    bottom: 120px;
    width: 52px;
    height: 52px;
    border-radius: 50%;
    z-index: 1100;
    display: grid;
    place-items: center;
}
.quick-summary-card {
    position: fixed;
    right: 16px;
    bottom: 180px;
    width: 320px;
    max-width: calc(100vw - 32px);
    background: #fff;
    border-radius: 12px;
    padding: 0.75rem 0.85rem;
    z-index: 1101;
}
.preview-thumb {
    width: 68px;
    height: 68px;
    border: 1px solid #e5e5e5;
    border-radius: 8px;
    overflow: hidden;
    background: #f9f9f9;
}
.preview-thumb img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}
@media (max-width: 768px) {
    .container-fluid.py-4 { padding: 1rem 0.5rem; }
    .compact-header { margin-bottom: 0.75rem !important; }
    .compact-header h2 { font-size: 1.25rem; }
    .compact-order-layout { --bs-gutter-x: 0.75rem; --bs-gutter-y: 1.25rem; }
    .sticky-actions {
        position: fixed;
        left: 0;
        right: 0;
        bottom: 0;
        background: #fff;
        padding: 0.75rem 1rem;
        box-shadow: 0 -6px 20px rgba(0,0,0,0.08);
        z-index: 1050;
    }
    .sticky-actions .btn { height: 48px; }
    body { padding-bottom: 110px; }
    .card .card-body { padding: 1rem; }
    .compact-order-body { padding: 0.75rem; }
    .compact-order-body .mb-4 { margin-bottom: 1.25rem !important; }
    .modal-full-mobile { margin: 0; }
    .modal-full-mobile .modal-content { min-height: 90vh; }
    .measure-row { padding: 0.25rem 0; }
    .measure-row .form-label { font-size: 0.85rem; }
    .measure-input .form-control { max-width: 100px; padding: 0.3rem 0.45rem; }
    .quick-summary-btn { bottom: 150px; right: 12px; }
    .quick-summary-card {
        right: 8px;
        left: 8px;
        bottom: 210px;
        width: auto;
        max-width: none;
    }
}
</style>
<script>
const garmentFields = {{ GARMENT_FIELDS|tojson }};
const clientSelect = document.getElementById('client_id');
const garmentSelect = document.getElementById('garment_type');
const measureFields = document.querySelectorAll('.measure-field');
const measureInputs = Array.from(document.querySelectorAll('.measure-field input'));
const btnSaveMeasures = document.getElementById('btnSaveMeasures');
const clientSearch = document.getElementById('clientSearch');
const btnSearchClient = document.getElementById('btnSearchClient');
const clientSearchStatus = document.getElementById('clientSearchStatus');
const clientResults = document.getElementById('clientResults');
const resetClientSearch = document.getElementById('resetClientSearch');
const openNewClientBtn = document.getElementById('openNewClient');
const selectedClientBox = document.getElementById('selectedClientBox');
const selectedClientName = document.getElementById('selectedClientName');
const selectedClientMeta = document.getElementById('selectedClientMeta');
const clearSelectedClient = document.getElementById('clearSelectedClient');
const newClientModalEl = document.getElementById('newClientModal');
const newClientModal = newClientModalEl && typeof bootstrap !== 'undefined' ? new bootstrap.Modal(newClientModalEl) : null;
const modalClientName = document.getElementById('modalClientName');
const modalClientPhone = document.getElementById('modalClientPhone');
const modalClientIdNumber = document.getElementById('modalClientIdNumber');
const newClientError = document.getElementById('newClientError');
const stepGarment = document.getElementById('stepGarment');
const stepMeasures = document.getElementById('stepMeasures');
const stepFinal = document.getElementById('stepFinal');
const measureWarning = document.getElementById('measureSaveWarning');
const refCheckbox = document.getElementById('reference_from_garment');
const refNotesBox = document.getElementById('referenceNotesBox');
const refNotesInput = refNotesBox ? refNotesBox.querySelector('textarea') : null;
const btnAddItem = document.getElementById('btnAddItem');
const itemsListEl = document.getElementById('itemsList');
const itemsJsonInput = document.getElementById('items_json');
const formElement = document.querySelector('form');
const quickSummaryToggle = document.getElementById('quickSummaryToggle');
const quickSummaryPanel = document.getElementById('quickSummaryPanel');
const quickSummaryClose = document.getElementById('quickSummaryClose');
const quickResumenCliente = document.getElementById('quickResumenCliente');
const quickResumenPrendas = document.getElementById('quickResumenPrendas');
const quickResumenEntrega = document.getElementById('quickResumenEntrega');
const quickResumenTotal = document.getElementById('quickResumenTotal');
const quickResumenAdelanto = document.getElementById('quickResumenAdelanto');
const quickResumenItems = document.getElementById('quickResumenItems');
const imagesInput = document.querySelector('input[name="images"]');
const imagePreviewList = document.getElementById('imagePreviewList');
const imagePreviewEmpty = document.getElementById('imagePreviewEmpty');
const resumenCliente = document.getElementById('resumenCliente');
const resumenPrendas = document.getElementById('resumenPrendas');
const resumenEntrega = document.getElementById('resumenEntrega');
const resumenTotal = document.getElementById('resumenTotal');
const resumenAdelanto = document.getElementById('resumenAdelanto');
const resumenItems = document.getElementById('resumenItems');
const inputTotal = document.querySelector('input[name="total"]');
const inputDeposit = document.querySelector('input[name="deposit"]');
const inputDelivery = document.querySelector('input[name="delivery_date"]');
const observationsInput = document.querySelector('textarea[name="observations"]');
const confirmModalEl = document.getElementById('confirmResumenModal');
const confirmBtn = document.getElementById('confirmResumenSubmit');
const confirmPrintBtn = document.getElementById('confirmResumenPrint');
const confirmDownloadBtn = document.getElementById('confirmResumenDownload');
const confirmResumenCliente = document.getElementById('confirmResumenCliente');
const confirmResumenPrendas = document.getElementById('confirmResumenPrendas');
const confirmResumenEntrega = document.getElementById('confirmResumenEntrega');
const confirmResumenTotal = document.getElementById('confirmResumenTotal');
const confirmResumenAdelanto = document.getElementById('confirmResumenAdelanto');
const confirmResumenItems = document.getElementById('confirmResumenItems');
const confirmResumenObservaciones = document.getElementById('confirmResumenObservaciones');

let selectedClient = null;
let itemsList = [];
let editingIndex = null;
let submitConfirmed = false;

function initGarmentPlaceholder() {
    if (!garmentSelect) return;
    const hasPlaceholder = garmentSelect.querySelector('option[value=""]');
    if (!hasPlaceholder) {
        const placeholder = document.createElement('option');
        placeholder.value = '';
        placeholder.textContent = 'Selecciona tipo de prenda';
        placeholder.disabled = true;
        placeholder.selected = true;
        garmentSelect.insertAdjacentElement('afterbegin', placeholder);
    } else if (!itemsList.length) {
        garmentSelect.value = '';
    }
}

function updateStepChips(activeStep) {
    document.querySelectorAll('.step-chip').forEach(chip => {
        const step = parseInt(chip.dataset.step, 10);
        chip.classList.remove('active-step', 'pending-step');
        if (step === activeStep) {
            chip.classList.add('active-step');
        } else if (step > activeStep) {
            chip.classList.add('pending-step');
        }
    });
}

function visibleFields(tipo) {
    const visibles = garmentFields[tipo] || [];
    measureFields.forEach(el => {
        const show = visibles.includes(el.dataset.field);
        el.style.display = show ? '' : 'none';
        if (!show) {
            const input = el.querySelector('input');
            if (input) input.value = '';
        }
    });
}

function resetMeasures() {
    measureFields.forEach(el => {
        const input = el.querySelector('input');
        if (input) input.value = '';
    });
}

function isMeasureVisible(input) {
    const container = input.closest('.measure-field');
    if (!container) return false;
    return getComputedStyle(container).display !== 'none';
}

function focusNextMeasure(current) {
    const visibles = measureInputs.filter(isMeasureVisible);
    const idx = visibles.indexOf(current);
    if (idx >= 0 && idx < visibles.length - 1) {
        visibles[idx + 1].focus();
        visibles[idx + 1].select();
    }
}

measureInputs.forEach(input => {
    const fieldName = input.closest('.measure-field')?.dataset.field || '';
    input.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
            e.preventDefault();
            focusNextMeasure(input);
        }
    });
    input.addEventListener('focus', () => input.classList.add('measure-highlight'));
    input.addEventListener('blur', () => input.classList.remove('measure-highlight'));
    input.addEventListener('input', () => {
        if (fieldName === 'color') return;
        const cleaned = input.value.replace(/[^0-9.,]/g, '');
        if (cleaned !== input.value) {
            input.value = cleaned;
        }
    });
});

function renderDefaultResults(message) {
    if (!clientResults) return;
    clientResults.innerHTML = `<div class="list-group-item text-muted small">${message || 'Sin resultados. Ingresa un nombre o telefono y presiona buscar.'}</div>`;
}

function ensureClientOption(client) {
    if (!clientSelect) return;
    const exists = Array.from(clientSelect.options).some(opt => opt.value === String(client.id));
    if (!exists) {
        const opt = new Option(`${client.name} (${client.phone || 'Sin telefono'})${client.id_number ? ' ? ' + client.id_number : ''}`, client.id);
        clientSelect.append(opt);
    }
}

function updateSelectedClientUI() {
    if (!selectedClientBox) return;
    if (selectedClient) {
        selectedClientName.textContent = selectedClient.name || 'Cliente seleccionado';
        const meta = [];
        if (selectedClient.phone) meta.push(selectedClient.phone);
        if (selectedClient.id_number) meta.push(`CI/NIT: ${selectedClient.id_number}`);
        selectedClientMeta.textContent = meta.join(' ? ') || 'Sin datos de contacto';
        selectedClientBox.classList.remove('alert-warning');
    } else {
        selectedClientName.textContent = 'Sin cliente seleccionado';
        selectedClientMeta.textContent = 'Selecciona un cliente existente o registra uno nuevo.';
        selectedClientBox.classList.add('alert-warning');
    }
}

function updateFlow() {
    const readyClient = !!selectedClient;
    const garmentChosen = readyClient && !!garmentSelect.value;
    const hasItem = itemsList.length > 0;
    stepGarment.classList.toggle('d-none', !readyClient);
    stepMeasures.classList.toggle('d-none', !(readyClient && garmentChosen));
    stepFinal.classList.toggle('d-none', !(readyClient && garmentChosen));
    garmentSelect.disabled = !readyClient;
    btnAddItem.disabled = !readyClient;
    btnSaveMeasures.disabled = !readyClient;
    measureWarning.classList.toggle('d-none', readyClient);
    document.querySelectorAll('#stepMeasures input, #stepMeasures textarea, #stepMeasures button').forEach(el => {
        if (el === btnAddItem || el === btnSaveMeasures || el.type === 'hidden') return;
        el.disabled = !readyClient;
    });
    document.querySelectorAll('#stepFinal input, #stepFinal textarea, #stepFinal select, #stepFinal button').forEach(el => {
        if (el.type === 'hidden') return;
        el.disabled = !readyClient;
    });
    const activeStep = !readyClient ? 1 : (!garmentChosen ? 2 : (!hasItem ? 3 : 4));
    updateStepChips(activeStep);
}

function setSelectedClient(client) {
    selectedClient = client ? {
        id: String(client.id),
        name: client.name || '',
        phone: client.phone || '',
        id_number: client.id_number || ''
    } : null;
    if (clientSelect) {
        if (selectedClient) {
            ensureClientOption(selectedClient);
            clientSelect.value = selectedClient.id;
        } else {
            clientSelect.value = '0';
        }
    }
    updateSelectedClientUI();
    updateFlow();
    updateResumen();
    if (selectedClient) {
        loadMeasures();
    } else {
        resetMeasures();
    }
}

function toggleReferenceNotes() {
    if (!refCheckbox || !refNotesBox) return;
    const show = refCheckbox.checked;
    refNotesBox.classList.toggle('d-none', !show);
    if (!show && refNotesInput) {
        refNotesInput.value = '';
    }
}

function toggleQuickSummary(force) {
    if (!quickSummaryPanel) return;
    const open = typeof force === 'boolean' ? force : quickSummaryPanel.classList.contains('d-none');
    quickSummaryPanel.classList.toggle('d-none', !open);
}

function renderImagePreviews(files) {
    if (!imagePreviewList) return;
    imagePreviewList.innerHTML = '';
    const fileList = files ? Array.from(files) : [];
    if (!fileList.length) {
        if (imagePreviewEmpty) imagePreviewEmpty.classList.remove('d-none');
        return;
    }
    if (imagePreviewEmpty) imagePreviewEmpty.classList.add('d-none');
    fileList.forEach(file => {
        const url = URL.createObjectURL(file);
        const box = document.createElement('div');
        box.className = 'preview-thumb';
        const img = document.createElement('img');
        img.src = url;
        img.alt = file.name;
        img.onload = () => URL.revokeObjectURL(url);
        box.appendChild(img);
        imagePreviewList.appendChild(box);
    });
}

async function searchClient() {
    const term = clientSearch.value.trim();
    if (!term) {
        clientSearchStatus.textContent = 'Ingresa un telefono o nombre para buscar.';
        renderDefaultResults();
        return;
    }
    clientSearchStatus.textContent = 'Buscando...';
    try {
        const res = await fetch(`/api/clientes/buscar?q=${encodeURIComponent(term)}`);
        if (!res.ok) throw new Error();
        const data = await res.json();
        renderClientResults(data || []);
        clientSearchStatus.textContent = data.length ? `${data.length} resultado(s) encontrados.` : 'No encontramos cliente, registra uno nuevo.';
        setSelectedClient(null);
    } catch (err) {
        console.error(err);
        clientSearchStatus.textContent = 'No se pudo buscar, intenta de nuevo.';
        renderClientResults([]);
    }
}

function renderClientResults(list) {
    if (!clientResults) return;
    clientResults.innerHTML = '';
    if (!list || !list.length) {
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.className = 'list-group-item list-group-item-action d-flex justify-content-between align-items-center';
        btn.dataset.clientId = 'new';
        btn.innerHTML = '<div><div class="fw-semibold">Nuevo cliente</div><div class="small text-muted">No encontramos coincidencias, registra uno nuevo.</div></div><i class="bi bi-person-plus"></i>';
        clientResults.appendChild(btn);
        return;
    }
    list.forEach(c => {
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.className = 'list-group-item list-group-item-action';
        btn.dataset.clientId = c.id;
        btn.dataset.clientName = c.name || '';
        btn.dataset.clientPhone = c.phone || '';
        btn.dataset.clientIdNumber = c.id_number || '';
        const phoneLabel = c.phone || 'Sin telefono';
        const idLabel = c.id_number ? `<div class="small text-muted">CI/NIT: ${c.id_number}</div>` : '';
        btn.innerHTML = `<div class="fw-semibold">${c.name} – ${phoneLabel}</div>${idLabel}`;
        clientResults.appendChild(btn);
    });
}

function openNewClientModal() {
    if (!newClientModal) return;
    const term = (clientSearch?.value || '').trim();
    if (/^\d+$/.test(term)) {
        modalClientPhone.value = term;
        modalClientName.value = '';
    } else {
        modalClientName.value = term;
        modalClientPhone.value = '';
    }
    modalClientIdNumber.value = '';
    if (newClientError) {
        newClientError.textContent = '';
        newClientError.classList.add('d-none');
    }
    newClientModal.show();
}

async function registerNewClient() {
    if (!newClientModal) return;
    const payload = {
        name: (modalClientName.value || '').trim(),
        phone: (modalClientPhone.value || '').trim(),
        id_number: (modalClientIdNumber.value || '').trim()
    };
    if (!payload.name) {
        newClientError.textContent = 'El nombre es obligatorio.';
        newClientError.classList.remove('d-none');
        return;
    }
    newClientError.classList.add('d-none');
    try {
        const res = await fetch('/api/clientes', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });
        const data = await res.json();
        if (!res.ok) {
            newClientError.textContent = data.error || 'No se pudo registrar el cliente.';
            newClientError.classList.remove('d-none');
            if (res.status === 409 && data.id) {
                setSelectedClient(data);
                newClientModal.hide();
            }
            return;
        }
        newClientModal.hide();
        setSelectedClient(data);
        renderClientResults([data]);
        clientSearchStatus.textContent = 'Cliente registrado y seleccionado.';
    } catch (err) {
        console.error(err);
        newClientError.textContent = 'No se pudo registrar el cliente.';
        newClientError.classList.remove('d-none');
    }
}

function handleNewClientCancel() {
    if (newClientModal) newClientModal.hide();
    setSelectedClient(null);
    renderDefaultResults('Sin resultados. Ingresa un nombre o telefono y presiona buscar.');
    if (clientSearch) clientSearch.value = '';
}

async function loadMeasures() {
    const clientId = selectedClient?.id;
    const tipo = garmentSelect.value;
    if (!clientId || !tipo) return;
    try {
        const res = await fetch(`/api/clientes/${clientId}/medidas?prenda=${encodeURIComponent(tipo)}`);
        if (!res.ok) return;
        const data = await res.json();
        resetMeasures();
        Object.entries(data || {}).forEach(([k,v]) => {
            const el = document.querySelector(`[data-field="${k}"] input`);
            if (el) el.value = v;
        });
    } catch (err) {
        console.error(err);
    }
}

async function saveMeasures() {
    const clientId = selectedClient?.id;
    const tipo = garmentSelect.value;
    if (!clientId) {
        alert('Selecciona un cliente antes de guardar medidas.');
        return;
    }
    const payload = { garment_type: tipo, measurements: {} };
    measureFields.forEach(el => {
        const input = el.querySelector('input');
        if (el.style.display !== 'none' && input && input.value) {
            payload.measurements[el.dataset.field] = input.value;
        }
    });
    try {
        const res = await fetch(`/api/clientes/${clientId}/medidas`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });
        if (!res.ok) throw new Error();
        alert('Medidas guardadas para el cliente.');
    } catch (err) {
        alert('No se pudieron guardar las medidas.');
    }
}

function renderItems() {
    if (!itemsListEl) return;
    if (!itemsList.length) {
        itemsListEl.textContent = 'Aun no hay prendas agregadas.';
        updateFlow();
        return;
    }
    const html = itemsList.map((it, idx) => {
        const entries = Object.entries(it.measurements || {}).filter(([k,_]) => !['referencia_prenda','nota_referencia'].includes(k));
        const measures = entries.map(([k,v]) => `<span class="badge text-bg-light border me-1 mb-1">${k.replace('_',' ')}: ${v}</span>`).join(' ');
        const ref = (it.measurements || {}).referencia_prenda ? '<span class="badge bg-info text-dark ms-1">Ref</span>' : '';
        return `<div class="border rounded p-2 mb-2 d-flex justify-content-between align-items-start">
            <div>
                <div class="fw-semibold">${idx+1}. ${it.garment_type} ${ref}</div>
                ${measures || '<div class="text-muted small">Sin medidas</div>'}
            </div>
            <div class="btn-group btn-group-sm">
                <button type="button" class="btn btn-outline-primary" data-action="edit-item" data-index="${idx}"><i class="bi bi-pencil"></i></button>
                <button type="button" class="btn btn-outline-danger" data-action="delete-item" data-index="${idx}"><i class="bi bi-trash"></i></button>
            </div>
        </div>`;
    }).join('');
    itemsListEl.innerHTML = html;
    updateFlow();
}

function addItemToList() {
    if (!selectedClient) {
        alert('Selecciona o registra un cliente antes de agregar prendas.');
        return;
    }
    const tipo = garmentSelect.value;
    if (!tipo) {
        alert('Selecciona el tipo de prenda.');
        return;
    }
    const measurements = {};
    measureFields.forEach(el => {
        if (el.style.display === 'none') return;
        const input = el.querySelector('input');
        if (input && input.value) {
            measurements[el.dataset.field] = input.value;
        }
    });
    if (refCheckbox && refCheckbox.checked) {
        measurements.referencia_prenda = 'Si';
        if (refNotesInput && refNotesInput.value) {
            measurements.nota_referencia = refNotesInput.value;
        }
    }
    if (editingIndex !== null) {
        itemsList[editingIndex] = { garment_type: tipo, measurements };
        editingIndex = null;
        btnAddItem.innerHTML = '<i class="bi bi-plus-circle me-1"></i>Agregar prenda a la lista';
        btnAddItem.classList.remove('btn-warning');
        btnAddItem.classList.add('btn-outline-success');
    } else {
        itemsList.push({ garment_type: tipo, measurements });
    }
    renderItems();
    updateResumen();
    updateFlow();
    measureFields.forEach(el => {
        const input = el.querySelector('input');
        if (input) input.value = '';
    });
    if (refNotesInput) refNotesInput.value = '';
    if (refCheckbox) refCheckbox.checked = false;
    toggleReferenceNotes();
}

garmentSelect.addEventListener('change', () => {
    visibleFields(garmentSelect.value);
    loadMeasures();
    updateFlow();
});
btnSaveMeasures.addEventListener('click', saveMeasures);
btnSearchClient.addEventListener('click', searchClient);
clientSearch.addEventListener('keydown', (e) => {
    if (e.key === 'Enter') {
        e.preventDefault();
        searchClient();
    }
});
resetClientSearch.addEventListener('click', () => {
    clientSearch.value = '';
    renderDefaultResults('Sin resultados. Ingresa un nombre o telefono y presiona buscar.');
    setSelectedClient(null);
    clientSearchStatus.textContent = 'Busca un cliente para comenzar.';
});
if (openNewClientBtn) openNewClientBtn.addEventListener('click', openNewClientModal);
if (clientResults) {
    clientResults.addEventListener('click', (e) => {
        const btn = e.target.closest('[data-client-id]');
        if (!btn) return;
        const cid = btn.dataset.clientId;
        if (cid === 'new') {
            openNewClientModal();
            return;
        }
        setSelectedClient({
            id: cid,
            name: btn.dataset.clientName,
            phone: btn.dataset.clientPhone,
            id_number: btn.dataset.clientIdNumber
        });
        clientResults.querySelectorAll('.list-group-item').forEach(el => el.classList.remove('active'));
        btn.classList.add('active');
    });
}
if (clearSelectedClient) {
    clearSelectedClient.addEventListener('click', () => {
        setSelectedClient(null);
        clientSearchStatus.textContent = 'Selecciona un cliente para continuar.';
    });
}
if (newClientModal) {
    document.getElementById('btnSaveNewClient')?.addEventListener('click', registerNewClient);
    document.getElementById('btnCancelNewClient')?.addEventListener('click', handleNewClientCancel);
}

document.addEventListener('DOMContentLoaded', () => {
    visibleFields(garmentSelect.value);
    initGarmentPlaceholder();
    if (clientSelect && clientSelect.value && clientSelect.value !== '0') {
        const opt = clientSelect.options[clientSelect.selectedIndex];
        setSelectedClient({
            id: clientSelect.value,
            name: opt ? opt.text : 'Cliente seleccionado',
            phone: '',
            id_number: ''
        });
    } else {
        updateSelectedClientUI();
        updateFlow();
    }
    updateFlow();
    renderDefaultResults('Sin resultados. Ingresa un nombre o telefono y presiona buscar.');
    toggleReferenceNotes();
    renderItems();
    updateResumen();
    toggleQuickSummary(false);
    if (imagesInput) renderImagePreviews(imagesInput.files);
});

if (refCheckbox) {
    refCheckbox.addEventListener('change', toggleReferenceNotes);
}

if (quickSummaryToggle) {
    quickSummaryToggle.addEventListener('click', () => {
        updateResumen();
        toggleQuickSummary();
    });
}
if (quickSummaryClose) {
    quickSummaryClose.addEventListener('click', () => toggleQuickSummary(false));
}
document.addEventListener('click', (e) => {
    if (!quickSummaryPanel || quickSummaryPanel.classList.contains('d-none')) return;
    const isBubble = quickSummaryToggle && (quickSummaryToggle === e.target || quickSummaryToggle.contains(e.target));
    const insidePanel = quickSummaryPanel.contains(e.target);
    if (!isBubble && !insidePanel) toggleQuickSummary(false);
});
document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') toggleQuickSummary(false);
});

if (imagesInput) {
    imagesInput.addEventListener('change', (e) => renderImagePreviews(e.target.files));
}

if (btnAddItem) {
    btnAddItem.addEventListener('click', addItemToList);
}

if (itemsListEl) {
    itemsListEl.addEventListener('click', (e) => {
        const btn = e.target.closest('button[data-action]');
        if (!btn) return;
        const idx = parseInt(btn.dataset.index, 10);
        if (isNaN(idx)) return;
        if (btn.dataset.action === 'delete-item') {
            itemsList.splice(idx, 1);
            renderItems();
            updateResumen();
            return;
        }
        if (btn.dataset.action === 'edit-item') {
            const item = itemsList[idx];
            if (!item) return;
            garmentSelect.value = item.garment_type;
            visibleFields(garmentSelect.value);
            resetMeasures();
            Object.entries(item.measurements || {}).forEach(([k,v]) => {
                const el = document.querySelector(`[data-field="${k}"] input`);
                if (el) el.value = v;
            });
            if (refCheckbox) {
                refCheckbox.checked = !!item.measurements?.referencia_prenda;
            }
            if (refNotesInput) {
                refNotesInput.value = item.measurements?.nota_referencia || '';
            }
            toggleReferenceNotes();
            editingIndex = idx;
            btnAddItem.innerHTML = '<i class="bi bi-save me-1"></i>Actualizar prenda';
            btnAddItem.classList.remove('btn-outline-success');
            btnAddItem.classList.add('btn-warning');
        }
    });
}

if (formElement) {
    formElement.addEventListener('submit', (e) => {
        e.stopImmediatePropagation();
        if (submitConfirmed) return;
        if (!selectedClient) {
            e.preventDefault();
            alert('Debes seleccionar o registrar un cliente antes de continuar.');
            return;
        }
        if (!itemsList.length) {
            const tipo = garmentSelect.value;
            const measurements = {};
            let hasMeasurements = false;
            measureFields.forEach(el => {
                if (el.style.display === 'none') return;
                const input = el.querySelector('input');
                if (input && input.value) {
                    measurements[el.dataset.field] = input.value;
                    hasMeasurements = true;
                }
            });
            if (refCheckbox && refCheckbox.checked) {
                measurements.referencia_prenda = 'Si';
                if (refNotesInput && refNotesInput.value) {
                    measurements.nota_referencia = refNotesInput.value;
                }
            }
            if (!tipo || (!hasMeasurements && Object.keys(measurements).length === 0)) {
                e.preventDefault();
                alert('Debes agregar al menos una prenda al pedido.');
                return;
            }
            itemsList.push({ garment_type: tipo, measurements });
        }

        if (itemsJsonInput) {
            itemsJsonInput.value = JSON.stringify(itemsList);
        }

        if (confirmModalEl && typeof bootstrap !== 'undefined') {
            e.preventDefault();
            const clientName = selectedClient ? selectedClient.name : '-';
            confirmResumenCliente.textContent = clientName || '-';
            confirmResumenPrendas.textContent = itemsList.length;
            confirmResumenEntrega.textContent = inputDelivery && inputDelivery.value ? inputDelivery.value : '-';
            confirmResumenTotal.textContent = inputTotal && inputTotal.value ? parseFloat(inputTotal.value).toFixed(2) : '0.00';
            confirmResumenAdelanto.textContent = inputDeposit && inputDeposit.value ? parseFloat(inputDeposit.value).toFixed(2) : '0.00';
            confirmResumenItems.textContent = itemsList.length ? itemsList.map((it, idx) => `${idx + 1}. ${it.garment_type}`).join(' | ') : 'Aun no hay prendas agregadas.';
            confirmResumenObservaciones.textContent = observationsInput && observationsInput.value ? observationsInput.value : '-';
            const modal = new bootstrap.Modal(confirmModalEl);
            modal.show();
            if (confirmBtn) {
                confirmBtn.onclick = () => {
                    submitConfirmed = true;
                    modal.hide();
                    formElement.submit();
                };
            }
        } else {
            submitConfirmed = true;
        }
    }, true);
}

function updateResumen() {
    if (resumenPrendas) resumenPrendas.textContent = itemsList.length;
    if (resumenCliente) {
        const clientName = selectedClient ? selectedClient.name : '-';
        resumenCliente.textContent = clientName || '-';
    }
    const entregaVal = inputDelivery && inputDelivery.value ? inputDelivery.value : '-';
    const totalVal = inputTotal && inputTotal.value ? parseFloat(inputTotal.value).toFixed(2) : '0.00';
    const adelantoVal = inputDeposit && inputDeposit.value ? parseFloat(inputDeposit.value).toFixed(2) : '0.00';
    if (resumenEntrega) resumenEntrega.textContent = entregaVal;
    if (resumenTotal) resumenTotal.textContent = totalVal;
    if (resumenAdelanto) resumenAdelanto.textContent = adelantoVal;
    if (resumenItems) {
        if (!itemsList.length) {
            resumenItems.textContent = 'Aun no hay prendas agregadas.';
        } else {
            resumenItems.innerHTML = itemsList.map((it, idx) => {
                return `${idx + 1}. ${it.garment_type}`;
            }).join(' | ');
        }
    }
    const clientName = selectedClient ? selectedClient.name : '-';
    if (quickResumenCliente) quickResumenCliente.textContent = clientName || '-';
    if (quickResumenPrendas) quickResumenPrendas.textContent = itemsList.length;
    if (quickResumenEntrega) quickResumenEntrega.textContent = entregaVal;
    if (quickResumenTotal) quickResumenTotal.textContent = totalVal;
    if (quickResumenAdelanto) quickResumenAdelanto.textContent = adelantoVal;
    if (quickResumenItems) {
        quickResumenItems.textContent = itemsList.length ? itemsList.map((it, idx) => `${idx + 1}. ${it.garment_type}`).join(' | ') : 'Aun no hay prendas agregadas.';
    }
}

if (inputTotal) inputTotal.addEventListener('input', updateResumen);
if (inputDeposit) inputDeposit.addEventListener('input', updateResumen);
if (inputDelivery) inputDelivery.addEventListener('change', updateResumen);

function downloadResumenImagen() {
    const canvas = document.createElement('canvas');
    canvas.width = 900;
    canvas.height = 360;
    const ctx = canvas.getContext('2d');
    ctx.fillStyle = '#ffffff';
    ctx.fillRect(0, 0, canvas.width, canvas.height);
    ctx.fillStyle = '#000000';
    ctx.font = '20px Arial';
    ctx.fillText('Resumen de pedido personalizado', 20, 40);
    ctx.font = '16px Arial';
    ctx.fillText(`Cliente: ${confirmResumenCliente.textContent}`, 20, 80);
    ctx.fillText(`Prendas: ${confirmResumenPrendas.textContent}`, 20, 110);
    ctx.fillText(`Entrega: ${confirmResumenEntrega.textContent}`, 20, 140);
    ctx.fillText(`Total: Bs ${confirmResumenTotal.textContent}`, 20, 170);
    ctx.fillText(`Adelanto: Bs ${confirmResumenAdelanto.textContent}`, 20, 200);
    ctx.fillText('Prendas agregadas:', 20, 230);
    const itemsLines = confirmResumenItems.textContent || '';
    ctx.fillText(itemsLines, 20, 260);
    ctx.fillText(`Observaciones: ${confirmResumenObservaciones.textContent}`, 20, 290);
    const link = document.createElement('a');
    link.download = 'resumen_pedido.png';
    link.href = canvas.toDataURL('image/png');
    link.click();
}

if (confirmPrintBtn) {
    confirmPrintBtn.addEventListener('click', () => window.print());
}
if (confirmDownloadBtn) {
    confirmDownloadBtn.addEventListener('click', downloadResumenImagen);
}
</script>
{% endblock %}
