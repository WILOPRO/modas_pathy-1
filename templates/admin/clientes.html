{% extends 'admin/base_admin.html' %}

{% block title %}Clientes - Modas Pathy{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="d-flex align-items-center justify-content-between mb-4">
        <div>
            <p class="text-muted small mb-1">Gestión de clientes</p>
            <h2 class="mb-0">Clientes</h2>
        </div>
        <a href="{{ url_for('admin_cliente_nuevo') }}" class="btn btn-primary">
            <i class="bi bi-person-plus"></i> Agregar cliente
        </a>
    </div>

    <div class="card shadow-sm border-0">
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table align-middle mb-0">
                    <thead class="table-light">
                        <tr>
                            <th>Nombre</th>
                            <th>Teléfono</th>
                            <th>Medidas guardadas</th>
                            <th class="text-end">Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for c in clientes %}
                        <tr>
                            <td class="fw-semibold">{{ c.name }}</td>
                            <td>{{ c.phone }}</td>
                            <td>
                                {% if c.measurements %}
                                    {{ c.measurements|length }} prenda(s)
                                {% else %}
                                    <span class="text-muted">Sin medidas</span>
                                {% endif %}
                            </td>
                            <td class="text-end">
                                <button type="button" class="btn btn-sm btn-outline-secondary me-1 btn-view-measures" data-client-id="{{ c.id }}" data-client-name="{{ c.name }}">
                                    <i class="bi bi-rulers"></i> Medidas
                                </button>
                                <a href="{{ url_for('admin_cliente_editar', id=c.id) }}" class="btn btn-sm btn-outline-primary">
                                    <i class="bi bi-pencil"></i> Editar
                                </a>
                            </td>
                        </tr>
                        {% else %}
                        <tr>
                            <td colspan="4" class="text-center py-4 text-muted">
                                <i class="bi bi-inbox me-2"></i>No hay clientes registrados.
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<div class="modal fade" id="measureModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Medidas de <span id="modalClientName"></span></h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
            </div>
            <div class="modal-body">
                <div class="row g-3 align-items-end">
                    <div class="col-md-6">
                        <label class="form-label">Tipo de prenda</label>
                        <select class="form-select" id="modalGarment"></select>
                    </div>
                    <div class="col-md-6 text-end">
                        <div class="small text-muted" id="modalStatus"></div>
                    </div>
                </div>
                <div class="row g-3 mt-3" id="modalMeasurements">
                    {% for field in ['largo_espalda','largo_delantero','cintura','busto','media_cintura','sisa','escote','largo_manga','puno','cuello','abertura','ancho_espalda','figura','alforza','panos','wato','corridas','color','cadera','talla','quebrado'] %}
                    <div class="col-md-4 modal-measure" data-field="{{ field }}">
                        <label class="form-label text-capitalize">{{ field.replace('_',' ') }}</label>
                        <input type="text" class="form-control" />
                    </div>
                    {% endfor %}
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-light" data-bs-dismiss="modal">Cerrar</button>
                <button type="button" class="btn btn-primary" id="btnModalSave">
                    <i class="bi bi-save me-1"></i> Guardar medidas
                </button>
            </div>
        </div>
    </div>
</div>

<script>
const modalGarmentTypes = {{ CUSTOM_ORDER_TYPES|tojson }};
const modalGarment = document.getElementById('modalGarment');
const modalMeasurements = document.querySelectorAll('#modalMeasurements .modal-measure');
const modalStatus = document.getElementById('modalStatus');
const modalName = document.getElementById('modalClientName');
const btnModalSave = document.getElementById('btnModalSave');
const modalElement = document.getElementById('measureModal');
const modalInstance = new bootstrap.Modal(modalElement);
let activeClient = null;

function renderGarmentOptions() {
    modalGarment.innerHTML = '';
    modalGarmentTypes.forEach(t => modalGarment.append(new Option(t, t)));
}

function toggleModalFields() {
    const visibles = {{ GARMENT_FIELDS|tojson }}[modalGarment.value] || [];
    modalMeasurements.forEach(el => {
        el.style.display = visibles.includes(el.dataset.field) ? '' : 'none';
        if (!visibles.includes(el.dataset.field)) {
            const input = el.querySelector('input');
            if (input) input.value = '';
        }
    });
}

async function loadModalMeasures() {
    if (!activeClient) return;
    modalStatus.textContent = 'Cargando medidas...';
    try {
        const res = await fetch(`/api/clientes/${activeClient}/medidas?prenda=${encodeURIComponent(modalGarment.value)}`);
        if (res.ok) {
            const data = await res.json();
            modalMeasurements.forEach(el => {
                const input = el.querySelector('input');
                if (input) input.value = '';
            });
            Object.entries(data || {}).forEach(([k,v]) => {
                const el = document.querySelector(`#modalMeasurements .modal-measure[data-field=\"${k}\"] input`);
                if (el) el.value = v;
            });
            modalStatus.textContent = 'Medidas cargadas.';
        } else {
            modalStatus.textContent = 'No se pudieron cargar las medidas.';
        }
    } catch (err) {
        console.error(err);
        modalStatus.textContent = 'No se pudieron cargar las medidas.';
    }
}

async function saveModalMeasures() {
    if (!activeClient) return;
    const payload = { garment_type: modalGarment.value, measurements: {} };
    document.querySelectorAll('#modalMeasurements .modal-measure').forEach(el => {
        const input = el.querySelector('input');
        if (el.style.display !== 'none' && input && input.value) {
            payload.measurements[el.dataset.field] = input.value;
        }
    });
    modalStatus.textContent = 'Guardando...';
    try {
        const res = await fetch(`/api/clientes/${activeClient}/medidas`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });
        if (!res.ok) throw new Error();
        modalStatus.textContent = 'Medidas guardadas.';
    } catch (err) {
        console.error(err);
        modalStatus.textContent = 'No se pudieron guardar las medidas.';
    }
}

document.querySelectorAll('.btn-view-measures').forEach(btn => {
    btn.addEventListener('click', () => {
        activeClient = btn.dataset.clientId;
        modalName.textContent = btn.dataset.clientName;
        modalStatus.textContent = '';
        renderGarmentOptions();
        toggleModalFields();
        loadModalMeasures();
        modalInstance.show();
    });
});

modalGarment.addEventListener('change', () => {
    toggleModalFields();
    loadModalMeasures();
});
btnModalSave.addEventListener('click', saveModalMeasures);
</script>
{% endblock %}
